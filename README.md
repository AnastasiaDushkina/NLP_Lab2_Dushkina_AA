# Мультиагентный помощник по настольным играм

**Лабораторная работа 2: Проектирование и реализация мультиагентной системы с использованием LangChain и LangGraph**

Душкина Анастасия Алексеевна, группа J4140

## Описание проекта

Этот проект реализует мультиагентную систему (МАС) на основе LangChain и LangGraph, которая помогает решать практические задачи:
- **Подбирать настольные игры** по критериям (количество игроков, время, сложность, жанры, темы, механики)
- **Сравнивать настольные игры** по различным параметрам
- **Объяснять игровые термины** (механики, жанры) из глоссария или через LLM
- **Отвечать на академические вопросы** по мультиагентным системам, LLM и архитектуре ИИ-приложений

Система использует паттерн **router + специализированные агенты**, работает с локальной базой игр и глоссарием b сохраняет краткую историю взаимодействий

## Архитектура системы

Система построена как граф (StateGraph), где каждый узел представляет отдельного специализированного агента:

### Агенты

1. **Router (Роутер)** — определяет тип запроса пользователя:
   - `search` — подбор настольной игры по критериям
   - `explain` — объяснение правил, механик, стратегий
   - `compare` — сравнение двух или более игр
   - `plan` — планирование игрового вечера
   - `general` — общие вопросы о настольных играх

2. **Memory (Агент памяти)** — управляет памятью системы:
   - Извлекает релевантную информацию из истории сессии
   - Обновляет профиль пользователя на основе запросов
   - Сохраняет предпочтения пользователя

3. **Planner (Планировщик)** — создает структурированный план рекомендации:
   - Парсит запрос пользователя в GameRecommendationPlan
   - Извлекает параметры поиска (игроки, время, сложность, жанры)

4. **Content Filter (Фильтр по содержанию)** — фильтрует игры по жанрам, темам, механикам

5. **Metadata Filter (Фильтр по метаданным)** — фильтрует игры по техническим параметрам (игроки, время, возраст, сложность)

6. **Merge Results (Объединение результатов)** — объединяет результаты двух фильтров

7. **Game Search (Поиск игр)** — выбирает лучшую игру из отфильтрованных результатов

8. **Explain (Объяснитель)** — объясняет правила, механики и стратегии игр:
   - Использует инструмент search_game_by_name для поиска информации об игре
   - Генерирует подробное объяснение на основе данных из базы

9. **Compare (Сравниватель)** — сравнивает игры между собой:
   - Использует инструмент compare_games_info для получения данных об играх
   - Создает структурированное сравнение

10. **Plan (Планировщик вечера)** — создает планы игровых вечеров:
    - Использует инструменты get_games_by_criteria и calculate_game_time
    - Создает структурированный план с временными рамками

11. **Theory (Теоретик)** — отвечает на теоретические вопросы

12. **Code (Программист)** — помогает с вопросами по программированию

13. **Update Memory (Обновление памяти)** — сохраняет результаты взаимодействия в память

14. **Final Response (Финальный ответ)** — формирует окончательный ответ пользователю

### Поток выполнения

```
START → Router → Memory → [Planner | Explain | Compare | Plan | Theory | Code]
                                    ↓
                            [Content Filter → Metadata Filter → Merge Results → Game Search]
                                    ↓
                            Update Memory → Final Response → END
```

Для запросов типа `search`: Router → Memory → Planner → Content Filter → Metadata Filter → Merge Results → Game Search → Update Memory → Final Response

Для запросов типа `explain`, `compare`, `plan`: Router → Memory → [Explain | Compare | Plan] → Update Memory → Final Response

Для запросов типа `general`, `theory`, `code`: Router → Memory → [Theory | Code] → Update Memory → Final Response

## Структура данных

### Game (Модель игры)
- `name` — название игры
- `players_min/max` — количество игроков
- `duration_min/max` — длительность партии (минуты)
- `min_age` — минимальный возраст
- `complexity` — сложность (1.0-5.0)
- `genres` — жанры
- `themes` — тематики
- `mechanics` — игровые механики
- `interaction` — уровень взаимодействия
- `language_dependence` — языковая зависимость
- `description` — описание

### SystemState (Состояние графа)
- `user_query` — запрос пользователя
- `user_id` — идентификатор пользователя
- `routing_decision` — решение роутера о типе агента
- `recommendation_plan` — план рекомендации (GameRecommendationPlan)
- `action_plan` — план действий (ActionPlan)
- `content_filtered` — игры после фильтрации по содержанию
- `metadata_filtered` — игры после фильтрации по метаданным
- `final_games` — финальный список подходящих игр
- `agent_response` — ответ агента (AgentResponse)
- `session_history` — история сессии (список взаимодействий)
- `user_preferences` — предпочтения пользователя
- `user_profile` — профиль пользователя
- `recommendation_history` — история рекомендованных игр
- `knowledge_base` — база знаний
- `final_answer` — финальный ответ
- `execution_path` — путь выполнения (последовательность агентов)

### Инструменты (Tools)

Система использует LangChain tools для работы с базой данных игр:

1. **search_game_by_name** — поиск игры по названию
2. **get_games_by_criteria** — поиск игр по критериям (игроки, время, сложность, жанры, темы, механики)
3. **calculate_game_time** — расчет общего времени для списка игр
4. **compare_games_info** — получение информации о двух играх для сравнения

## Установка и настройка

### Требования

- **Python 3.9 или новее**
- Доступ к LLM через API (LiteLLM или OpenAI)

### Установка зависимостей

Установите необходимые библиотеки:

```bash
pip install -r requirements.txt
```

Или вручную:

```bash
pip install openai langchain langchain-openai langchain-core langgraph pydantic python-dotenv
```

### Настройка окружения

Создайте файл `.env` в корне проекта со следующими параметрами:

```env
LITELLM_BASE_URL=http://your-vllm-server:34000/v1
LITELLM_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
MODEL_NAME=xxxxx-xxx
```

Или для OpenAI:

```env
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## Использование

### Запуск в Jupyter Notebook

Откройте файл `NLP_Lab2_Dushkina_AA.ipynb` и выполните все ячейки. В системе прописаны 6 тестовых запросов:

1. Рекомендация игры для вечеринки
2. Объяснение термина "драфт"
3. Сравнение двух игр (Каскадия и Азул)
4. Академический вопрос о паттерне router
5. Вопрос по проектированию МАС
6. Вопрос по программированию LangGraph
