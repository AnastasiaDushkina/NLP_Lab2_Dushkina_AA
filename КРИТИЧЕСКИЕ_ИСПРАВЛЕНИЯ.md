# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –Ω–æ—É—Ç–±—É–∫–∞

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±–ª–µ–º

–í—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã **–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã**. –ù–∏–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π.

---

## 1. ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ explain_node - –ù–ï –ù–ê–ô–î–ï–ù–û

–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: `explain_node` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (—è—á–µ–π–∫–∞ 34). –ü—Ä–æ–±–ª–µ–º—ã –Ω–µ—Ç.

---

## 2. ‚ùå SystemState –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `run_system` –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –ø–æ–ª—è –∏–∑ `SystemState`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ 44 (run_system):**

–ó–∞–º–µ–Ω–∏—Ç–µ:
```python
initial_state: SystemState = {
    "user_query": query,
    "user_id": user_id,
    "routing_decision": None,
    "action_plan": None,
    "agent_response": None,
    "session_history": [],
    "user_profile": {},
    "knowledge_base": {},
    "final_answer": "",
    "execution_path": []
}
```

–ù–∞:
```python
initial_state: SystemState = {
    "user_query": query,
    "user_id": user_id,
    "routing_decision": None,
    "recommendation_plan": None,      # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    "action_plan": None,
    "content_filtered": [],           # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    "metadata_filtered": [],          # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    "final_games": [],                # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    "agent_response": None,
    "session_history": [],
    "user_preferences": {},           # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    "user_profile": {},
    "recommendation_history": [],     # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    "knowledge_base": {},
    "final_answer": "",
    "execution_path": []
}
```

---

## 3. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç game_search_node –≤ –≥—Ä–∞—Ñ–µ - –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:** `game_search_node` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞, –Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≥—Ä–∞—Ñ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ 40 (–≥—Ä–∞—Ñ):**

–î–æ–±–∞–≤—å—Ç–µ –ø–æ—Å–ª–µ `workflow.add_node("planner", planner_node)`:
```python
workflow.add_node("content_filter", content_filter_node)
workflow.add_node("metadata_filter", metadata_filter_node)
workflow.add_node("merge_results", merge_results_node)
workflow.add_node("game_search", game_search_node)
workflow.add_node("explain", explain_node)
workflow.add_node("compare", compare_node)
workflow.add_node("plan", plan_node)
```

---

## 4. ‚ùå –ù–µ—Ç compare_node –≤ –≥—Ä–∞—Ñ–µ - –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:** `compare_node` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞, –Ω–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ –≥—Ä–∞—Ñ—É.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –°–º. –ø—É–Ω–∫—Ç 3 - –¥–æ–±–∞–≤—å—Ç–µ `workflow.add_node("compare", compare_node)`

---

## 5. ‚ùå –ü–ª–æ—Ö–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è - –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:** `route_after_router` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `"search"`, `"explain"`, `"compare"`, `"plan"`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ 38 (route_after_router):**

–ó–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞:
```python
def route_after_router(state: SystemState) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª –ø–æ—Å–ª–µ —Ä–æ—É—Ç–µ—Ä–∞"""
    routing_decision = state.get("routing_decision")
    
    if not routing_decision:
        return "theory"
    
    agent_type = routing_decision.agent_type
    
    if routing_decision.needs_planning:
        return "planner"
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ —Ç–∏–ø—ã –∞–≥–µ–Ω—Ç–æ–≤
    if agent_type == "search":
        return "planner"  # –î–ª—è search –Ω—É–∂–µ–Ω planner —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    elif agent_type == "explain":
        return "explain"
    elif agent_type == "compare":
        return "compare"
    elif agent_type == "plan":
        return "planner"
    elif agent_type == "theory":
        return "theory"
    elif agent_type == "code":
        return "code"
    elif agent_type == "general":
        return "theory"
    else:
        return "theory"

def route_after_planner(state: SystemState) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª –ø–æ—Å–ª–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
    routing_decision = state.get("routing_decision")
    
    if not routing_decision:
        return "game_search"
    
    agent_type = routing_decision.agent_type
    
    if agent_type == "search":
        return "content_filter"  # –î–ª—è search –∏–¥–µ–º –≤ —Ü–µ–ø–æ—á–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    elif agent_type == "plan":
        return "plan"  # –î–ª—è plan –∏–¥–µ–º –≤ plan —É–∑–µ–ª
    elif agent_type == "code":
        return "code"
    else:
        return "game_search"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–¥–µ–º –≤ game_search
```

---

## 6. ‚ùå –ü–∞–º—è—Ç—å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è - –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–ª—å–∫–æ `theory` –∏ `code` –∏–¥—É—Ç –≤ `update_memory`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ 40 (–≥—Ä–∞—Ñ):**

–ó–∞–º–µ–Ω–∏—Ç–µ:
```python
workflow.add_edge("theory", "update_memory")
workflow.add_edge("code", "update_memory")
```

–ù–∞:
```python
# –í—Å–µ –∞–≥–µ–Ω—Ç—ã –∏–¥—É—Ç –≤ update_memory
workflow.add_edge("game_search", "update_memory")
workflow.add_edge("explain", "update_memory")
workflow.add_edge("compare", "update_memory")
workflow.add_edge("plan", "update_memory")
workflow.add_edge("theory", "update_memory")
workflow.add_edge("code", "update_memory")
```

---

## 7. ‚ùå –ü–æ–ª–µ action_plan –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è - –ß–ê–°–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** `action_plan` –µ—Å—Ç—å –≤ `SystemState`, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å `None`.

**–°—Ç–∞—Ç—É—Å:** –£–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `None` –≤ `run_system`, —á—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ù–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —É–∑–ª—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –Ω–∞ `None` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.

---

## üìù –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞ (—è—á–µ–π–∫–∞ 40)

–ó–∞–º–µ–Ω–∏—Ç–µ –≤–µ—Å—å –±–ª–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∞ –Ω–∞:

```python
workflow = StateGraph(SystemState)

# –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —É–∑–ª—ã
workflow.add_node("router", router_node)
workflow.add_node("memory", memory_node)
workflow.add_node("planner", planner_node)
workflow.add_node("content_filter", content_filter_node)
workflow.add_node("metadata_filter", metadata_filter_node)
workflow.add_node("merge_results", merge_results_node)
workflow.add_node("game_search", game_search_node)
workflow.add_node("explain", explain_node)
workflow.add_node("compare", compare_node)
workflow.add_node("plan", plan_node)
workflow.add_node("theory", theory_node)
workflow.add_node("code", code_node)
workflow.add_node("update_memory", update_memory_node)
workflow.add_node("final_response", final_response_node)

# –ù–∞—á–∞–ª–æ –≥—Ä–∞—Ñ–∞
workflow.add_edge(START, "router")

# –ü–æ—Å–ª–µ —Ä–æ—É—Ç–µ—Ä–∞ –≤—Å–µ–≥–¥–∞ –∏–¥–µ–º –≤ memory
workflow.add_edge("router", "memory")

# –ü–æ—Å–ª–µ memory –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∞–≥–µ–Ω—Ç–∞
workflow.add_conditional_edges(
    "memory",
    route_after_router,
    {
        "planner": "planner",
        "explain": "explain",
        "compare": "compare",
        "plan": "plan",
        "theory": "theory",
        "code": "code"
    }
)

# –ü–æ—Å–ª–µ planner –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è search –∏–ª–∏ plan
workflow.add_conditional_edges(
    "planner",
    route_after_planner,
    {
        "content_filter": "content_filter",
        "plan": "plan",
        "code": "code",
        "game_search": "game_search"
    }
)

# –¶–µ–ø–æ—á–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è search
workflow.add_edge("content_filter", "metadata_filter")
workflow.add_edge("metadata_filter", "merge_results")
workflow.add_edge("merge_results", "game_search")

# –í—Å–µ –∞–≥–µ–Ω—Ç—ã –∏–¥—É—Ç –≤ update_memory
workflow.add_edge("game_search", "update_memory")
workflow.add_edge("explain", "update_memory")
workflow.add_edge("compare", "update_memory")
workflow.add_edge("plan", "update_memory")
workflow.add_edge("theory", "update_memory")
workflow.add_edge("code", "update_memory")

# –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –∏–¥–µ–º –≤ final_response
workflow.add_edge("update_memory", "final_response")
workflow.add_edge("final_response", END)

app = workflow.compile()

print("–ì—Ä–∞—Ñ —Å–æ–∑–¥–∞–Ω —Å–æ –≤—Å–µ–º–∏ —É–∑–ª–∞–º–∏")
```

---

## ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç:
- ‚úÖ –ò–º–µ—Ç—å –≤—Å–µ —É–∑–ª—ã –≤ –≥—Ä–∞—Ñ–µ
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å –ø–∞–º—è—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è



